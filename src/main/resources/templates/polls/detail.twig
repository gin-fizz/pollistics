{% extends "../layouts/main.twig" %}

{% block pageTitle %}{{ poll.title }}{% endblock %}
{% block description %}{{ poll.title }} {{ poll.options }}{% endblock %}

{% block content %}
	<h1>{{ poll.title }} (id: {{ poll.id }})</h1>
	{% if poll.slug %}
		<p>{{ poll.slug }}</p>
	{% endif %}

	<form method="post" action="/polls/vote/{% if poll.slug is empty %}{{ poll.id }}{% else %}{{ poll.slug }}{% endif %}" class="poll">
		{%- for option, nVotes in poll.options %}
		<div class="poll--vote">
			<label for="{{ option }}">{{ option }}: {{ nVotes }}</label>
			<input type="radio" name="option" id="{{ option }}" value="{{ option }}">
		</div>
		<div>
		<input type="hidden" name="{{ _csrf.parameterName }}" value="{{ _csrf.token }}"/>
	</div>
		{%- endfor %}
		<button type="submit">Vote</button>
	</form>
	<form method="post" action="/polls/delete/{{ poll.id }}">
		<input type="submit" value="delete">
		<input type="hidden" name="{{ _csrf.parameterName }}" value="{{ _csrf.token }}"/>
	</form>
	<div class="social">
		<a href="https://www.facebook.com/sharer/sharer.php?u={{ "https://pollistics.com/" | urlencode }}{% if poll.slug is empty %}{{ poll.id }}{% else %}{{ poll.slug }}{% endif %}&quote={{poll.title|url_encode}}" target="_blank" rel="noopener" class="cta">share on facebook</a>
		<a href="https://twitter.com/intent/tweet?text={{ "what do you think about this?" + poll.title + "via Pollistics" | url_encode }}+{{ "https://pollistics.com/" | urlencode }}{% if poll.slug is empty %}{{ poll.id }}{% else %}{{ poll.slug }}{% endif %}" target="_blank" rel="noopener" class="cta">share on twitter</a>
		<input type="text" disabled id="share-url" value="https://pollistics.com/{% if poll.slug is empty %}{{ poll.id }}{% else %}{{ poll.slug }}{% endif %}">
		<button role="button" id="copy">🔗</button>
	</div>
	<div id="results"></div>
{% endblock %}

{% block scripts %}
	<script src="{{ asset('node_modules/d3/d3.min.js') }}"></script>
	<script src="{{ asset('node_modules/d3pie/d3pie/d3pie.min.js') }}"></script>
	<script>
		var options = []; // todo: do this with jsonify stuff
		{% for option, nVotes in poll.options -%}
		options.push({label: "{{option}}", value: {{ nVotes }}});
		{% endfor %}
		new d3pie('results', {
			data: {
				content: options
			}
		});
	</script>
	<!-- sharing -->
	<script>
		// https://developers.google.com/web/updates/2015/04/cut-and-copy-commands?hl=en
		const copyBtn = document.getElementById('copy');
		copyBtn.disabled = !document.queryCommandSupported('copy');

		copyBtn.addEventListener('click', () => {
			// Select the email link anchor text
			const output = document.getElementById('share-url');
			let range = document.createRange();
			range.selectNode(output);
			window.getSelection().addRange(range);

			try {
				// Now that we've selected the anchor text, execute the copy command
				var copy = document.execCommand('copy');
				log((copy ? '✅' : '❌'));
			} catch (err) {
				log('❌');
			}

			function log(text) {
				const old = copyBtn.textContent;
				copyBtn.textContent = text;
				setTimeout(() => {
					copyBtn.textContent = old;
				}, 2000);
			}

			// Remove the selections - NOTE: Should use
			// removeRange(range) when it is supported
			window.getSelection().removeAllRanges();
		});
	</script>
{% endblock %}
