{% extends "../layouts/main.twig" %}

{% block pageTitle %}{{ poll.title }}{% endblock %}
{% block description %}{{ poll.title }} {{ poll.options }}{% endblock %}

{% block content %}
	<h1>{{ poll.title }} (id: {{ poll.id }})</h1>
	{% if poll.slug %}
		<p>{{ poll.slug }}</p>
	{% endif %}

	<div id="results"></div>

	<div class="social" id="social">
		<a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fpollistics.com%2F{% if poll.slug is empty %}{{ poll.id }}{% else %}{{ poll.slug }}{% endif %}&quote={{poll.title|url_encode}}" target="_blank" rel="noopener" class="cta">share on facebook</a>
		<a href="https://twitter.com/intent/tweet?text={{ poll.title ~ "\n\n" ~ "via Pollistics â€” https://pollistics.com/" | url_encode }}{% if poll.slug is empty %}{{ poll.id }}{% else %}{{ poll.slug }}{% endif %}" target="_blank" rel="noopener" class="cta">share on twitter</a>
	</div>
{% endblock %}

{% block scripts %}
	<style>
		.arc text {
			font: 10px sans-serif;
			text-anchor: middle;
		}

		.arc path {
			stroke: #fff;
		}
	</style>
	<script src="{{ asset('node_modules/d3/build/d3.min.js') }}"></script>
	<script>
		var options = []; // todo: do this with jsonify stuff
		{% for option, nVotes in poll.options -%}
		options.push({label: "{{option}}", value: {{ nVotes }}});
		{% endfor %}

		const width = 500;
		const height = 500;
		const radius = Math.min(width, height) / 2;

		const color = d3.scaleOrdinal()
			.range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

		const arc = d3.arc()
			.outerRadius(radius - 10)
			.innerRadius(radius - 70);

		const pie = d3.pie()
			.sort(null)
			.value(d => d.value);

		const svg = d3.select("body").append("svg")
			.attr("width", width)
			.attr("height", height)
			.append("g")
			.attr("transform", `translate(${width / 2},${height / 2})`);

		const g = svg.selectAll(".arc")
			.data(pie(options))
			.enter().append("g")
			.attr("class", "arc");

		g.append("path")
			.attr("d", arc)
			.style("fill", d => color(d.data.label));

		g.append("text")
			.attr("transform", (d) => `translate(${arc.centroid(d)})`)
			.attr("dy", ".35em")
			.text((d) => d.data.label);

		g.append("text")
			.attr("transform", (d) => {
				console.log(d);
				return `translate(${arc.centroid(d)})`;
			})
			.attr("dy", ".35em")
			.text((d) => d.data.value);

	</script>

	<script src="/js/dist/results.js"></script>
{% endblock %}
