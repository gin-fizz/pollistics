{% extends "../layouts/main.twig" %}

{% block pageTitle %}{{ poll.title }}{% endblock %}
{% block description %}{{ poll.title }} {{ poll.options }}{% endblock %}

{% block content %}
	<h1>{{ poll.title }} (id: {{ poll.id }})</h1>
	{% if poll.slug %}
		<p>{{ poll.slug }}</p>
	{% endif %}

	<div id="results"></div>

	<div class="social">
		<div class="social--item">
			<a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fpollistics.com%2F{% if poll.slug is empty %}{{ poll.id }}{% else %}{{ poll.slug }}{% endif %}&quote={{poll.title|url_encode}}" target="_blank" rel="noopener" class="cta">share on facebook</a>
			<a href="https://twitter.com/intent/tweet?text={{ poll.title ~ "\n\n" ~ "via Pollistics â€” https://pollistics.com/" | url_encode }}{% if poll.slug is empty %}{{ poll.id }}{% else %}{{ poll.slug }}{% endif %}" target="_blank" rel="noopener" class="cta">share on twitter</a>
		</div>
		<div class="social--item" id="social"></div>
	</div>
{% endblock %}

{% block scripts %}
	<style>
		.arc text {
			font: 10px sans-serif;
			text-anchor: middle;
		}

		.arc path {
			stroke: #fff;
		}
	</style>
	<style>

		svg {
			width: 100%;
			height: 100%;
			position: center;
		}

		.toolTip {
			font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
			position: absolute;
			display: none;
			width: auto;
			height: auto;
			background: none repeat scroll 0 0 white;
			border: 0 none;
			border-radius: 8px 8px 8px 8px;
			box-shadow: -3px 3px 15px #888888;
			color: black;
			font: 12px sans-serif;
			padding: 5px;
			text-align: center;
		}

		text {
			font: 10px sans-serif;
			color: white;
		}
		text.value {
			font-size: 120%;
			fill: white;
		}

		.axisHorizontal path{
			fill: none;
		}

		.axisHorizontal .tick line {
			stroke-width: 1;
			stroke: rgba(0, 0, 0, 0.2);
		}

		.bar {
			fill: steelblue;
			fill-opacity: .9;
		}

	</style>
	<script src="{{ asset('node_modules/d3/build/d3.min.js') }}"></script>
	<script src="{{ asset('node_modules/d3-tip/index.js') }}"></script>
	<script>
		var data = []; // todo: do this with jsonify stuff
		{% for option, nVotes in poll.options -%}
		data.push({label: "{{option}}", value: {{ nVotes }}});
		{% endfor %}

		{#const width = 500;#}
		{#const height = 500;#}
		{#const radius = Math.min(width, height) / 2;#}

		{#const color = d3.scaleOrdinal()#}
			{#.range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);#}

		{#const arc = d3.arc()#}
			{#.outerRadius(radius - 10)#}
			{#.innerRadius(radius - 70);#}

		{#const pie = d3.pie()#}
			{#.sort(null)#}
			{#.value(d => d.value);#}

		{#const svg = d3.select("body").append("svg")#}
			{#.attr("width", width)#}
			{#.attr("height", height)#}
			{#.append("g")#}
			{#.attr("transform", `translate(${width / 2},${height / 2})`);#}

		{#const g = svg.selectAll(".arc")#}
			{#.data(pie(options))#}
			{#.enter().append("g")#}
			{#.attr("class", "arc");#}

		{#g.append("path")#}
			{#.attr("d", arc)#}
			{#.style("fill", d => color(d.data.label));#}

		{#g.append("text")#}
			{#.attr("transform", (d) => `translate(${arc.centroid(d)})`)#}
			{#.attr("dy", ".35em")#}
			{#.text((d) => d.data.label);#}

		{#g.append("text")#}
			{#.attr("transform", (d) => {#}
				{#console.log(d);#}
				{#return `translate(${arc.centroid(d)})`;#}
			{#})#}
			{#.attr("dy", ".35em")#}
			{#.text((d) => d.data.value);#}

	</script>
	<script>
		var div = d3.select("body").append("div").attr("class", "toolTip");

		var axisMargin = 20,
			margin = 40,
			valueMargin = 4,
			width = parseInt(d3.select('body').style('width'), 10),
			height = parseInt(d3.select('body').style('height'), 10),
			barHeight = (height-axisMargin-margin*2)* 0.4/data.length,
			barPadding = (height-axisMargin-margin*2)*0.6/data.length,
			data, bar, svg, scale, xAxis, labelWidth = 0;

		max = d3.max(data, function(d) { return d.value; });

		svg = d3.select('body')
			.append("svg")
			.attr("width", width)
			.attr("height", height);


		bar = svg.selectAll("g")
			.data(data)
			.enter()
			.append("g");

		bar.attr("class", "bar")
			.attr("cx",0)
			.attr("transform", function(d, i) {
				return "translate(" + margin + "," + (i * (barHeight + barPadding) + barPadding) + ")";
			});

		bar.append("text")
			.attr("class", "label")
			.attr("y", barHeight / 2)
			.attr("dy", ".35em") //vertical align middle
			.text(function(d){
				return d.label;
			}).each(function() {
			labelWidth = Math.ceil(Math.max(labelWidth, this.getBBox().width));
		});

		scale = d3.scaleLinear()
			.domain([0, max + max *0.20])
			.range([0, width - margin*2 - labelWidth]);

		xAxis = d3.axisBottom()
			.scale(scale)
			.tickSize(-height + 2*margin + axisMargin)

		bar.append("rect")
			.attr("transform", "translate("+labelWidth+", 0)")
			.attr("height", barHeight)
			.attr("width", function(d){
				return scale(d.value);
			});

		bar.append("text")
			.attr("class", "value")
			.attr("y", barHeight / 2)
			.attr("dx", -valueMargin + labelWidth) //margin right
			.attr("dy", ".35em") //vertical align middle
			.attr("text-anchor", "end")
			.text(function(d){
				return (d.value+" Votes");
			})
			.attr("x", function(d){
				var width = this.getBBox().width;
				return Math.max(width + valueMargin, scale(d.value));
			});

		bar
			.on("mousemove", function(d){
				div.style("left", d3.event.pageX+10+"px");
				div.style("top", d3.event.pageY-25+"px");
				div.style("display", "inline-block");
				div.html((d.label)+"<br>"+(d.value)+"%");
			});
		bar
			.on("mouseout", function(d){
				div.style("display", "none");
			});

		svg.insert("g",":first-child")
			.attr("class", "axisHorizontal")
			.attr("transform", "translate(" + (margin + labelWidth) + ","+ (height - axisMargin - margin)+")")
			.call(xAxis);

	</script>
	<script src="/js/dist/results.js"></script>
{% endblock %}
